<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | TLE Portal</title>

  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon.ico') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>

<body>

{% set clean_role = role|lower|trim %}

<main
  class="main"
  data-role="{{ clean_role }}"
  data-user-center="{{ user_center if user_center else '' }}"
>

  <div id="toastContainer"></div>

  <!-- === TOP BAR === -->
  <div class="top-bar">
    {% if clean_role != 'admin' %}
    <div class="center-label">
      Center: <strong>{{ user_center }}</strong>
    </div>
    {% endif %}

    <!-- Search Input With Accessible Label -->
    <label for="searchInput" class="visually-hidden">Search Records</label>
    <input
      id="searchInput"
      class="search-input"
      type="text"
      placeholder="Search records..."
      aria-label="Search Records"
    />

    <a href="/logout" class="btn btn-ghost logout-btn">Logout</a>
  </div>

  <!-- === KPI CARDS === -->
  <section class="kpis">
    <div class="card kpi blue">
      <div>{{ total }}</div>
      <small>Total Records</small>
    </div>

    <div class="card kpi purple">
      <div class="kpi-inner">
        <div class="kpi-mini">
          <span class="count green">{{ approved_count }}</span>
          <small>Approved</small>
        </div>
        <div class="kpi-mini">
          <span class="count red">{{ not_approved_count }}</span>
          <small>Not Approved</small>
        </div>
        <div class="kpi-mini">
          <span class="count orange">{{ pending_count }}</span>
          <small>Pending</small>
        </div>
      </div>
      <small class="kpi-title">Approvals Summary</small>
    </div>

    <div class="card kpi gold">
      <div class="badge gold">{{ total_adjustment_amount }}</div>
      <small>Total Amount</small>
    </div>
  </section>

  <!-- === ADMIN BULK BUTTONS === -->
  {% if clean_role == 'admin' %}
  <section class="card table-card bulk-section">
    <div class="bulk-actions">
      <button id="setPendingBtn" class="btn btn-gold" type="button" aria-label="Set Pending">Set Pending</button>
      <button id="setApprovedBtn" class="btn btn-blue" type="button" aria-label="Set Approved">Set Approved</button>
      <button id="setNotApprovedBtn" class="btn btn-purple" type="button" aria-label="Set Not Approved">Set Not Approved</button>
    </div>
    <div id="bulkMsg" class="bulk-message"></div>
  </section>
  {% endif %}

  <!-- === TABLE CONTAINER === -->
  <section class="card table-card">

      <!-- === TABLE HEADER === -->
      {% if clean_role == 'admin' %}
      <div class="table-header">
        <div class="filter-left">

          <!-- Center Filter (Labelled) -->
          <label for="adminCenterFilter" class="visually-hidden">Filter by Center</label>
          <select id="adminCenterFilter" class="filter-dropdown" aria-label="Filter by Center">
            <option value="">All Centers</option>
            {% for c in centers %}
            <option value="{{ c }}" {% if selected_center == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>

          <!-- Status Filter -->
          <label for="statusFilter" class="visually-hidden">Filter by status</label>
          <select id="statusFilter" class="filter-dropdown status-filter" aria-label="Filter by approval status">
              <option value="">All Status</option>
              <option value="Approved">Approved</option>
              <option value="Pending">Pending</option>
              <option value="Not Approved">Not Approved</option>
          </select>
        </div>

        <div class="view-more-wrap">
          <button id="viewMoreBtn" class="btn btn-ghost" type="button" aria-label="View More Columns">View More</button>
        </div>
      </div>
      {% else %}
      <div class="table-header">
        <div class="center-label">
          Center: <strong>{{ user_center }}</strong>
        </div>

        <div class="view-more-wrap">
          <button class="viewMoreBtn btn btn-ghost"
                  type="button"
                  aria-label="View More Columns">
              View More
          </button>
        </div>
      </div>  
      {% endif %}

<!-- FIXED HEADER -->
<div class="table-header-fixed">
    <table class="table-grid table-grid-header">
        <thead>
            <tr>
                {% if clean_role == 'admin' %}
                <th scope="col">
                    <label for="selectAllBtn" class="visually-hidden">Select All Rows</label>
                    <input type="checkbox" id="selectAllBtn" aria-label="Select All Rows">
                </th>
                {% endif %}

                <th scope="col">Centre</th>
                <th scope="col">Family</th>
                <th scope="col" data-sort="child">Child's Name</th>
                <th scope="col" data-sort="amount">Adjustment Amount</th>
                <th scope="col">Note/Description</th>
                <th scope="col">Pulling Category</th>
                <th scope="col">Pulling Instructions</th>
                <th scope="col">Start Date</th>
                <th scope="col">End Date</th>
                <th scope="col">Adjustment is Recurring?</th>
                <th scope="col">Approval</th>

                <th scope="col" class="extra-col">Child Status</th>
                <th scope="col" class="extra-col">Family Status</th>
                <th scope="col" class="extra-col">Billing Cycle</th>

                <th scope="col">Actions</th>
            </tr>
        </thead>
    </table>
</div>


<!-- SCROLLABLE BODY -->
<div class="table-horizontal-scroll">
    <div class="table-scroll-container">
        <table class="table-grid table-grid-body">
            <tbody id="recordsTbody">

                {% for row in data %}
                <tr data-id="{{ row['ID'] }}">

                    {% if clean_role == 'admin' %}
                    <td>
                        <label class="visually-hidden">Select Row</label>
                        <input type="checkbox" class="row-select" aria-label="Select Row">
                    </td>
                    {% endif %}

                    <td>{{ row["Centre"] }}</td>
                    <td>{{ row["Family"] }}</td>
                    <td>{{ row["Child's Name"] }}</td>
                    <td>${{ row["Adjustment Amount"] }}</td>
                    <td>{{ row["Note/Description"] }}</td>
                    <td>{{ row["Pulling Category"] }}</td>
                    <td>{{ row["Pulling Instructions"] }}</td>
                    <td>{{ row["Start Date"] }}</td>
                    <td>{{ row["End Date"] }}</td>
                    <td>{{ row["Adjustment is Recurring?"] }}</td>
                    <td>{{ row["Approval"] }}</td>

                    <td class="extra-col">{{ row["Child Status"] }}</td>
                    <td class="extra-col">{{ row["Family Status"] }}</td>
                    <td class="extra-col">{{ row["Billing Cycle"] }}</td>

                    <td class="t-actions">
                        <button class="t-btn icon edit" aria-label="Edit Record">
                            <img src="/Static/img/edit.png" alt="Edit">
                        </button>
                        <button class="t-btn icon delete" aria-label="Delete Record">
                            <img src="/Static/img/delete.png" alt="Delete">
                        </button>
                    </td>

                </tr>
                {% endfor %}

            </tbody>
        </table>
    </div>
</div>

      <!-- === FOOTER === -->
      <div class="table-footer">

        <!-- Rows per page -->
        <div class="rows-per-page">
          <label for="rowsPerPageSelect">Show rows:</label>
          <select id="rowsPerPageSelect" aria-label="Rows per page">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="15">15</option>
            <option value="20">20</option>
          </select>
        </div>

        <!-- Pagination -->
        <div class="pagination-container">
          <button id="prevPage" class="page-nav-btn" type="button" aria-label="Previous Page">Previous</button>
          <div id="pagination" class="pagination-numbers"></div>
          <button id="nextPage" class="page-nav-btn" type="button" aria-label="Next Page">Next</button>
        </div>

      </div>

      {% if clean_role == 'user' %}
      <div class="add-row-wrap">
        <button id="addRowBtn" class="btn btn-blue" type="button" aria-label="Add New Record">Add Record</button>
      </div>
      {% endif %}

      <div class="export-bar">
        <a id="exportBtn" class="btn btn-purple" href="/export" aria-label="Export to Excel">Export Excel</a>
      </div>

    </div>
  </section>

  <footer class="min">Â© {{ current_year or 2025 }} ASA</footer>

</main>

<script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
