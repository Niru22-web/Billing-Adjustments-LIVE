<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | TLE Portal</title>

  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon.ico') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>

<body>

{% set clean_role = role|lower|trim %}

<main
  class="main"
  data-role="{{ clean_role }}"
  data-user-center="{{ user_center if user_center else '' }}"
>

  <div id="toastContainer"></div>

  <!-- === TOP BAR === -->
  <div class="top-bar">
    {% if clean_role != 'admin' %}
    <div class="center-label">
      Center: <strong>{{ user_center }}</strong>
    </div>
    {% endif %}

    <input
      id="searchInput"
      class="search-input"
      type="text"
      placeholder="Search records..."
      aria-label="Search Records"
    />

    <a href="/logout" class="btn btn-ghost logout-btn">Logout</a>
  </div>

  <!-- ⭐⭐⭐ NEW KPI SUMMARY SECTION ⭐⭐⭐ -->
  <section class="kpi-summary-wrapper">

    <div class="kpi-summary-card">

        <div class="kpi-summary-title">Approval Summary</div>

        <div class="kpi-summary-line"></div>

        <div class="kpi-summary-grid">

            <div class="kpi-summary-item">
                <div class="kpi-value">{{ total }}</div>
                <div class="kpi-label">Total Records</div>
            </div>

            <div class="kpi-summary-item">
                <div class="kpi-value green">{{ approved_count }}</div>
                <div class="kpi-label">Approved</div>
            </div>

            <div class="kpi-summary-item">
                <div class="kpi-value red">{{ not_approved_count }}</div>
                <div class="kpi-label">Not Approved</div>
            </div>

            <div class="kpi-summary-item">
                <div class="kpi-value orange">{{ pending_count }}</div>
                <div class="kpi-label">Pending</div>
            </div>

            <div class="kpi-summary-item">
                <div class="kpi-value gold">{{ total_adjustment_amount }}</div>
                <div class="kpi-label">Total Amount</div>
            </div>

        </div>

    </div>

  </section>
  <!-- ⭐⭐⭐ END KPI SECTION ⭐⭐⭐ -->

  <!-- === ADMIN BULK BUTTONS === -->
  {% if clean_role == 'admin' %}
  <section class="card table-card bulk-section">
    <div class="bulk-actions">
      <button id="setPendingBtn" class="btn btn-gold">Set Pending</button>
      <button id="setApprovedBtn" class="btn btn-blue">Set Approved</button>
      <button id="setNotApprovedBtn" class="btn btn-purple">Set Not Approved</button>
    </div>
    <div id="bulkMsg" class="bulk-message"></div>
  </section>
  {% endif %}

  <!-- === TABLE CONTAINER === -->
  <section class="card table-card">

      <!-- === TABLE HEADER === -->
      {% if clean_role == 'admin' %}
      <div class="table-header">
        <div class="filter-left">
          <select id="adminCenterFilter" class="filter-dropdown">
            <option value="">All Centers</option>
            {% for c in centers %}
            <option value="{{ c }}" {% if selected_center == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>

          <select id="statusFilter" class="filter-dropdown">
              <option value="">All Status</option>
              <option value="Approved">Approved</option>
              <option value="Pending">Pending</option>
              <option value="Not Approved">Not Approved</option>
          </select>
        </div>

        <button id="viewMoreBtn" class="btn btn-ghost">View More</button>
      </div>

      {% else %}
      <div class="table-header">
        <div class="center-label">
          Center: <strong>{{ user_center }}</strong>
        </div>
        <button class="viewMoreBtn btn btn-ghost">View More</button>
      </div>
      {% endif %}

      <!-- === SCROLL WRAPPER === -->
      <div class="table-scroll-container">

      <!-- === TABLE === -->
      <table class="table-grid">
        <thead>
          <tr>
            {% if clean_role == 'admin' %}
            <th><input type="checkbox" id="selectAllBtn"></th>
            {% endif %}

            <th>Centre</th>
            <th>Family</th>

            <th data-column="Child's Name" class="sortable" data-sort="child">
                Child's Name <span class="sort-icon">↑↓</span>
            </th>

            <th data-column="Adjustment Amount" class="sortable" data-sort="amount">
                Adjustment Amount <span class="sort-icon">↑↓</span>
            </th>

            <th>Note/Description</th>
            <th>Pulling Category</th>
            <th>Pulling Instructions</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Adjustment is Recurring?</th>
            <th>Approval</th>

            <th class="hidden-col extra-col">Child Status</th>
            <th class="hidden-col extra-col">Family Status</th>
            <th class="hidden-col extra-col">Billing Cycle</th>

            <th>Actions</th>
          </tr>
        </thead>

        <tbody id="recordsTbody">
          {% for row in data %}
          <tr data-id="{{ row['ID'] }}">

            {% if clean_role == 'admin' %}
            <td><input type="checkbox" class="row-select"></td>
            {% endif %}

            <td>{{ row["Centre"] }}</td>
            <td>{{ row["Family"] }}</td>
            <td>{{ row["Child's Name"] }}</td>
            <td>${{ row["Adjustment Amount"] }}</td>
            <td>{{ row["Note/Description"] }}</td>
            <td>{{ row["Pulling Category"] }}</td>
            <td>{{ row["Pulling Instructions"] }}</td>
            <td>{{ row["Start Date"] }}</td>
            <td>{{ row["End Date"] }}</td>
            <td>{{ row["Adjustment is Recurring?"] }}</td>
            <td>{{ row["Approval"] }}</td>

            <td class="hidden-col extra-col">{{ row["Child Status"] }}</td>
            <td class="hidden-col extra-col">{{ row["Family Status"] }}</td>
            <td class="hidden-col extra-col">{{ row["Billing Cycle"] }}</td>

            <td class="t-actions">
              <button class="t-btn icon edit"><img src="/Static/img/edit.png"></button>
              <button class="t-btn icon delete"><img src="/Static/img/delete.png"></button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      </div>

      <!-- === FOOTER === -->
      <div class="table-footer">

        <div class="rows-per-page">
          Show:
          <select id="rowsPerPageSelect">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="15">15</option>
            <option value="20">20</option>
          </select>
          rows
        </div>

        <div class="pagination-container">
          <button id="prevPage" class="page-nav-btn">Previous</button>
          <div id="pagination" class="pagination-numbers"></div>
          <button id="nextPage" class="page-nav-btn">Next</button>
        </div>

      </div>

      {% if clean_role == 'user' %}
      <div class="add-row-wrap">
        <button id="addRowBtn" class="btn btn-blue">Add Record</button>
      </div>
      {% endif %}

      <div class="export-bar">
        <a id="exportBtn" class="btn btn-purple" href="/export">Export Excel</a>
      </div>

  </section>

  <footer class="min">© {{ current_year or 2025 }} ASA</footer>

</main>

<script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
